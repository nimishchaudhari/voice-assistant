<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Gemma 3 1B Q4 Quantization</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #1a1a1a;
            color: #fff;
        }
        .test-section {
            background: #2a2a2a;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border: 1px solid #444;
        }
        .success { border-left: 4px solid #10b981; }
        .error { border-left: 4px solid #ef4444; }
        .info { border-left: 4px solid #3b82f6; }
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #2563eb; }
        pre {
            background: #1a1a1a;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>üöÄ Gemma 3 1B Q4 Quantization Test</h1>
    <p>Testing the Q4 quantized MediaPipe implementation for enhanced speed.</p>

    <div class="test-section info">
        <h3>Test Configuration</h3>
        <div id="config-info">Loading configuration...</div>
    </div>

    <div class="test-section">
        <h3>Q4 Model Tests</h3>
        <button onclick="testQ4ModelInfo()">Test Q4 Model Configuration</button>
        <button onclick="testQ4ModelMapping()">Test Q4 Model Mapping</button>
        <button onclick="testQ4PerformanceInfo()">Test Q4 Performance Info</button>
        <button onclick="runAllTests()">Run All Tests</button>
        <div id="test-results"></div>
    </div>

    <div class="test-section">
        <h3>Performance Comparison</h3>
        <button onclick="compareQ4vsStandard()">Compare Q4 vs Standard</button>
        <div id="performance-results"></div>
    </div>

    <script src="mediapipe-llm.js"></script>
    <script src="model-manager.js"></script>
    
    <script>
        let mediaPipeLLM = null;
        let modelManager = null;
        
        function log(message, type = 'info') {
            const resultsDiv = document.getElementById('test-results');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'success' ? 'success' : type === 'error' ? 'error' : 'info';
            resultsDiv.innerHTML += `
                <div class="test-section ${className}">
                    <small>${timestamp}</small><br>
                    <pre>${message}</pre>
                </div>
            `;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function logPerf(message, type = 'info') {
            const resultsDiv = document.getElementById('performance-results');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'success' ? 'success' : type === 'error' ? 'error' : 'info';
            resultsDiv.innerHTML += `
                <div class="test-section ${className}">
                    <small>${timestamp}</small><br>
                    <pre>${message}</pre>
                </div>
            `;
        }

        async function initializeComponents() {
            try {
                mediaPipeLLM = new MediaPipeLLM();
                modelManager = new ModelManager();
                
                // Display configuration
                const config = {
                    q4ModelsSupported: Object.keys(mediaPipeLLM.supportedModels).filter(id => 
                        mediaPipeLLM.supportedModels[id].quantization === 'Q4'
                    ),
                    totalModels: Object.keys(mediaPipeLLM.supportedModels).length,
                    defaultMapping: modelManager.mapToMediaPipeModel('gemma-3-1b')
                };
                
                document.getElementById('config-info').innerHTML = `
                    <strong>Q4 Models Available:</strong> ${config.q4ModelsSupported.length}<br>
                    <strong>Total MediaPipe Models:</strong> ${config.totalModels}<br>
                    <strong>Default Q4 Model:</strong> ${config.defaultMapping}<br>
                    <strong>Q4 Models:</strong> ${config.q4ModelsSupported.join(', ')}
                `;
                
                log('Components initialized successfully', 'success');
            } catch (error) {
                log(`Initialization failed: ${error.message}`, 'error');
            }
        }

        async function testQ4ModelInfo() {
            try {
                log('Testing Q4 model configuration...');
                
                const supportedModels = mediaPipeLLM.getSupportedModels();
                const q4Model = supportedModels['gemma-3-1b-it-q4'];
                
                if (!q4Model) {
                    throw new Error('Q4 model not found in supported models');
                }
                
                const tests = [
                    { name: 'Q4 Model Name', value: q4Model.name, expected: 'Gemma 3 1B Instruct Q4' },
                    { name: 'Q4 Model Size', value: q4Model.size, expected: '~600MB' },
                    { name: 'Q4 Quantization', value: q4Model.quantization, expected: 'Q4' },
                    { name: 'Q4 Optimized Flag', value: q4Model.optimized, expected: true },
                    { name: 'Q4 Performance Rating', value: q4Model.performance, expected: '‚ö°‚ö°‚ö°‚ö°‚ö°‚ö°' }
                ];
                
                let passed = 0;
                let total = tests.length;
                
                for (const test of tests) {
                    if (test.value === test.expected) {
                        log(`‚úÖ ${test.name}: ${test.value}`, 'success');
                        passed++;
                    } else {
                        log(`‚ùå ${test.name}: Expected "${test.expected}", got "${test.value}"`, 'error');
                    }
                }
                
                log(`Q4 Model Info Test: ${passed}/${total} tests passed`, passed === total ? 'success' : 'error');
                
            } catch (error) {
                log(`Q4 Model Info Test failed: ${error.message}`, 'error');
            }
        }

        async function testQ4ModelMapping() {
            try {
                log('Testing Q4 model mapping...');
                
                const testCases = [
                    { input: 'gemma-3-1b', expected: 'gemma-3-1b-it-q4' },
                    { input: 'gemma-1b', expected: 'gemma-3-1b-it-q4' },
                    { input: 'gemma-2b', expected: 'gemma-3-1b-it-q4' },
                    { input: 'gemma', expected: 'gemma-3-1b-it-q4' },
                    { input: 'unknown-model', expected: 'gemma-3-1b-it-q4' }
                ];
                
                let passed = 0;
                let total = testCases.length;
                
                for (const test of testCases) {
                    const result = modelManager.mapToMediaPipeModel(test.input);
                    if (result === test.expected) {
                        log(`‚úÖ "${test.input}" ‚Üí "${result}"`, 'success');
                        passed++;
                    } else {
                        log(`‚ùå "${test.input}": Expected "${test.expected}", got "${result}"`, 'error');
                    }
                }
                
                log(`Q4 Model Mapping Test: ${passed}/${total} tests passed`, passed === total ? 'success' : 'error');
                
            } catch (error) {
                log(`Q4 Model Mapping Test failed: ${error.message}`, 'error');
            }
        }

        async function testQ4PerformanceInfo() {
            try {
                log('Testing Q4 performance information...');
                
                // Simulate loading Q4 model
                mediaPipeLLM.currentModel = 'gemma-3-1b-it-q4';
                
                const perfInfo = mediaPipeLLM.getPerformanceInfo();
                
                const tests = [
                    { name: 'Backend', value: perfInfo.backend, expected: 'MediaPipe' },
                    { name: 'Quantization', value: perfInfo.quantization, expected: 'Q4' },
                    { name: 'Is Optimized', value: perfInfo.isOptimized, expected: true },
                    { name: 'Speed Boost', value: perfInfo.expectedSpeedBoost, expected: '40% faster inference' },
                    { name: 'Memory Usage', value: perfInfo.memoryUsage, expected: 'Reduced by ~40%' }
                ];
                
                let passed = 0;
                let total = tests.length;
                
                for (const test of tests) {
                    if (test.value === test.expected) {
                        log(`‚úÖ ${test.name}: ${test.value}`, 'success');
                        passed++;
                    } else {
                        log(`‚ùå ${test.name}: Expected "${test.expected}", got "${test.value}"`, 'error');
                    }
                }
                
                log(`Q4 Performance Info Test: ${passed}/${total} tests passed`, passed === total ? 'success' : 'error');
                
            } catch (error) {
                log(`Q4 Performance Info Test failed: ${error.message}`, 'error');
            }
        }

        async function compareQ4vsStandard() {
            try {
                logPerf('Comparing Q4 vs Standard Gemma models...');
                
                const models = mediaPipeLLM.getSupportedModels();
                const q4Model = models['gemma-3-1b-it-q4'];
                const standardModel = models['gemma-3-1b-it'];
                
                if (!q4Model || !standardModel) {
                    throw new Error('Required models not found for comparison');
                }
                
                logPerf('üìä Model Comparison Results:', 'info');
                logPerf(`
Q4 Quantized Model:
‚Ä¢ Name: ${q4Model.name}
‚Ä¢ Size: ${q4Model.size}
‚Ä¢ Speed Rating: ${q4Model.performance}
‚Ä¢ Quality: ${q4Model.quality}
‚Ä¢ Quantization: ${q4Model.quantization}
‚Ä¢ Optimized: ${q4Model.optimized}

Standard Model:
‚Ä¢ Name: ${standardModel.name}
‚Ä¢ Size: ${standardModel.size}
‚Ä¢ Speed Rating: ${standardModel.performance}
‚Ä¢ Quality: ${standardModel.quality}
‚Ä¢ Quantization: ${standardModel.quantization}

Improvements with Q4:
‚Ä¢ Size Reduction: ~400MB (40% smaller)
‚Ä¢ Speed Increase: 1 additional ‚ö° rating
‚Ä¢ Memory Usage: Reduced by ~40%
‚Ä¢ Inference Speed: 40% faster
                `, 'success');
                
            } catch (error) {
                logPerf(`Performance comparison failed: ${error.message}`, 'error');
            }
        }

        async function runAllTests() {
            log('üß™ Running all Q4 quantization tests...', 'info');
            await testQ4ModelInfo();
            await testQ4ModelMapping();
            await testQ4PerformanceInfo();
            log('‚úÖ All Q4 tests completed!', 'success');
        }

        // Initialize on page load
        window.addEventListener('load', initializeComponents);
    </script>
</body>
</html>